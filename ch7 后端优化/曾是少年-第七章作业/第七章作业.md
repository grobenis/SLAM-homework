# 第七章作业

作者：曾是少年

## 二 Bundle Adjustment 

### 2.1 文献阅读(2 分)

我们在第五讲中已经介绍了Bundle Adjustment，指明它可以用于解PnP 问题。现在，我们又在后端中说明了它可以⽤于解⼤规模的三维重构问题，但在实时SLAM 场合往往需要控制规模。事实上，Bundle Adjustment 的历史远⽐我们想象的要长。请阅读Bill Triggs 的经典论文Bundle Adjustment: A Modern Synthesis（见paper/⽬录）1，了解BA 的发展历史，然后回答下列问题：

#### 1. 为何说Bundle Adjustment is slow 是不对的？

答：原文中如下所示：

```
“Optimization / bundle adjustment is slow”: Such statements often appear in papers introducing yet another heuristic Structure from Motion (SFM) iteration. The claimed slowness is almost always due to the unthinking use of a general-purpose optimization routine that completely ignores the problem structure and sparseness. Real bundle routines are much more efﬁcient than this, and usually considerably more efﬁcient and ﬂexible than the newly suggested method (§6, 7). That is why bundle adjustment remains the dominant structure reﬁnement technique for real applications, after 40 years of research.
```



翻译：“优化/束调整运行缓慢”：这种陈述经常出现在介绍启发式SFM的论文中。他们把BA速度缓慢的原因归咎于通用优化例程，该例程完全忽略了问题的结构和稀疏性。实际的BA例程比这要有效得多，并且通常比新提出的方法（第6、7节）更加有效和灵活。这就是在为什么经过40年的研究后，束调整仍然是实际应用中占主导地位的结构精炼技术。

#### 2. BA 中有哪些需要注意参数化的地方？Pose 和Point 各有哪些参数化⽅式？有何优缺点。



#### 3. 本文写于2000 年，但是⽂中提到的很多内容在后面十几年的研究中得到了印证。你能看到哪些方向在后续工作中有所体现？请举例说明。

### 2.2 BAL-dataset

BAL（Bundle Adjustment in large）[数据集](http://grail.cs.washington.edu/projects/bal/)是⼀个⼤型BA 数据集，它提供了相机与点初始值与观测，你可以⽤它们进⾏Bundle Adjustment。现在，请你使⽤`g2o`，⾃⼰定义`Vertex `和`Edge`（不要使用自带的顶点类型，也不要像本书例程那边调用`Ceres`来求导），书写`BAL` 上的`BA` 程序。你可以挑选其中⼀个数据，运行你的BA，并给出优化后的点云图。

本题不提供代码框架，请独立完成。

提示：

1. 注意BAL 的投影模型⽐教材中介绍的多了个负号；





## 三 直接法的 Bundle Adjustment (5 分，约 3 小时)
### 3.1 数学模型
特征点法的 BA 以最小化重投影误差作为优化目标。相对的，如果我们以最小化光度误差为目标，就得到了直接法的 BA。之前我们在直接法 VO 中，谈到了如何用直接法去估计相机位姿。但是直接法亦可用来处理整个 `Bundle Adjustment`。下面，请你推导直接法 BA 的数学模型，并完成它的 g2o 实现。注意本题使用的参数化形式与实际的直接法还有⼀点不同，我们用 x, y, z 参数化每⼀个 3D 点，而实际的直接法多采用逆深度参数化 [1]。
本题给定 7 张图片，记为 0.png 至 6.png，每张图片对应的相机位姿初始值为 $T_i$，以 $T_{cw}$ 形式存储在 `poses.txt` 文件中，其中每⼀行代表⼀个相机的位姿，格式如之前作业那样：
$time, t_x, t_y, t_z, q_x, q_y, q_z, q_w$
平移在前，旋转（四元数形式）在后。同时，还存在⼀个 3D 点集 P，共 N 个点。其中每⼀个点的初始坐标记作 $p_i = [x, y, z]$ 。每个点还有自己的固定灰度值，我们用 16 个数来描述，这 16 个数为该点周围 4x4的小块读数，记作 $I(p)_i$，顺序见图 1 。换句话说，小块从 `u − 2`,` v − 2` 取到 `u + 1`,` v + 1`，先迭代 `v`。那么，我们知道，可以把每个点投影到每个图像中，然后再看投影后点周围小块与原始的 4x4 小块有多大差异。那么，整体优化目标函数为：
$$
\min\sum^7_{j=1}\sum^N_{i=1}\sum_W||I(p_i)-I_j(\pi(KT_jp_i))||^2_2
$$
即最⼩化任意点在任意图像中投影与其本⾝颜⾊之差。其中K 为相机内参（在程序内以全局变量形式给定），$\pi$为投影函数，$W$ 指代整个`patch`。下面，请回答：
1. 如何描述任意⼀点投影在任意⼀图像中形成的error？
2. 每个error 关联⼏个优化变量？
3. error 关于各变量的雅可⽐是什么？

### 3.2 实现

下⾯，请你根据上述说明，使⽤ g2o 实现上述优化，并⽤ pangolin 绘制优化结果。程序框架见 code/di-rectBA.cpp ⽂件。实现过程中，思考并回答以下问题：

1.	能否不要以 [x, y, z]T 的形式参数化每个点？
2.	取 4x4 的 patch 好吗？取更⼤的 patch 好还是取⼩⼀点的 patch 好？
3.	从本题中，你看到直接法与特征点法在 BA 阶段有何不同？
4.	由于图像的差异，你可能需要鲁棒核函数，例如 Huber。此时 Huber 的阈值如何选取？
5.	提⽰：

1.	构建 Error 之前先要判断点是否在图像中，去除⼀部分边界的点。
2.	优化之后，Pangolin 绘制的轨迹与地图如图 1 所⽰。
3.	你也可以不提供雅可⽐的计算过程，让 g2o ⾃⼰计算⼀个数值雅可⽐。
4.	以上数据实际取⾃ DSO[1]。