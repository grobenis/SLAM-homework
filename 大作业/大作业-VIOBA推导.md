# 大作业 VIO中的BA推导

## 题目

在 `VIO` 里，除了传统的 `bundle adjustment` 以外，我们还有 `IMU` 提供的测量量。请根据文献 [1]，推导并实现带有 IMU 测量的 `Bundle Adjustment`。以下是一些提示：

## 首先，请推导 IMU测量方程，即角速度和加速度分别测到的是什么量。这其中需要用到相机的运动学，请一并推导。

答: 

### IMU测量模型

IMU主要有加速度计和陀螺仪两部分构成,加速度计可以测得IMU单元的加速度$a$.陀螺仪可以测得IMU的角速度$w$.由于误差的存在,IMU得到的观测值并不准确. IMU主要存在以下确定性误差和不确定性误差两种. 其中,确定性误差包括Bias,Scale等,不确定性误差包括高斯白噪声$n_a$,$n_g$和随机游走$n_w,g_w$.

可以得到IMU加速度计的误差模型如下:

假设导航系 G 为东北天,g $G = (0, 0, −9.81)^⊤$ 。理论测量值为:
$$
a_m^b = R_{bG}(a^G − g^G)
$$
其中,$R_{bG}$是从IMU坐标系到东北天坐标系的旋转矩阵. 

如果考虑高斯白噪声,bias,以及尺度因子,则为:
$$
a_m^b = S_a R_{bG}(a^G − g^G) + n^a + b^a (23)
$$
通常假设尺度因子为单位矩阵。一般情况下不估计尺度因子.

考虑尺度因子,高斯白噪声,以及 bias, 陀螺仪的误差模型如下:
$$
ω^b_{m} = S_g ω^b + n^g + b^g
$$
因此,考虑简单的IMU模型.可以得到如下的**误差模型**,也就是IMU的**测量模型**如下:
$$
\tilde{w}^b = ω^b + b^g + n^g\\
\tilde{a}^b = q_{bw}(a^w +g^w ) + b^a + n^a
$$
上标 g 表示 gyro , a 表示 acc, w 表示在世界坐标系 world,b 表示 imu 机体坐标系 body。上式中,a与g之间的加号也可以是减号(视习惯等确定).IMU 的真实值为 ω, a, 测量值为 $\tilde{w}$, $\tilde{a}$, P(ose),V(elocity),Q(uaternion) 对时间的导数可写成:
$$
\dot{P_{w{b_t}}}=v^w_t\\
\dot{v}^w_t=a^w_t\\
\dot{q}_{wb_t} = q_{wb_t}\otimes \left[\begin{array}{ccc} 0\\ \frac{1}{2}w^{b_t}\end{array}\right]
$$
采用最基本的欧拉法,可以从第i时刻,对IMU的测量值进行积分,可以得到第j时刻的PVQ:
$$
p_{wb_j}=p_{wB_i}+v^w_i\Delta t +\int\int_{t\in[i,j]}(q_{wb_t}a^{b_t}-g^w)\delta t^2\\
v^w_j = v^w_i+\int_{t\in[i,j]}(q_wb_ta^{b_t}-g^w)\delta^t\\
ww.ba
$$




## 第二，请说明按照图优化的思路，如何建立 VIO的图模型？其中包括哪些节点和边？

答: 在 VIO系统中,估计的状态变量如下:
$$
\chi = [x_n,x_{n+1},...,x_{n+N},\lambda_m,\lambda_{m+1},...,\lambda_{m+M}]\\
x_i = [p_{wb_i},q_{wb_i},v^w_i,b^{b_i}_a,b^{b_i}_g]^T,i\in[n,n+N]
$$
其中:

* $x_i$ 包含 i 时刻 IMU 机体的在惯性坐标系中的位置,速度,姿态,以及 IMU 机体坐标系中的加速度和角速度的偏置量估计。
* n, m 分别是机体状态量,路标在滑动窗口里的起始时刻。
* N 滑动窗口中关键帧数量。
* M 是被滑动窗口内所有关键帧观测到的路标数量。

## 第三，说明各节点储存的量是什么，各边的误差如何计算，雅可比如何计算？



## 最后，利用 Ceres、g2o 或 gtsam 等库实现这些运算。

你也可以参考其他文献来回答这些问题。请注意 `VIO` 中的数学符号比较多，请使用一致的符号。